#!/usr/bin/env ruby

# vim: set tabstop=2 shiftwidth=2 softtabstop=2 cc=100;

require 'commander/import'
require 'resque'
require 'terminal-table'
require 'geoloader'

program :version, '0.0.1'
program :description, 'Load GeoTIFFs and Shapefiles into PostGIS, Geoserver, and Solr.'

#
# Load a batch manifest or an individual GeoTIFF / Shapefile.
#
command :load do |c|
  c.syntax  = 'geoloader load [filename]'
  c.summary = 'Load a YAML batch manifest.'
  c.option  "-q", "--resque", "Push jobs onto Resque."
  c.action do |args, options|

    options.default :resque => false

    # Load the manifest.
    manifest_path = File.expand_path(args[0])
    manifest = YAML::load(File.read(manifest_path))

    # Process each of the matched files.
    Dir.glob("#{File.dirname(manifest_path)}/#{manifest["files"]}") do |f|
      case File.extname(f)
      when ".shp"
        load_shapefile(f, manifest, options.resque)
      when ".tif"
        load_geotiff(f, manifest, options.resque)
      end
    end

  end
end

#
# Spin up a Resque worker.
#
command :work do |c|
  c.syntax  = 'geoloader work'
  c.summary = 'Start a Resque worker.'
  c.action do |args, options|
    Resque::Worker.new("geoloader").work
  end
end

#
# Delete all databases, stores, and documents in a workspace.
#
command :clear do |c|
  c.syntax  = 'geoloader clear [workspace]'
  c.summary = 'Clear a workspace.'
  c.action do |args, options|
    Geoloader::Geoserver.new.delete_workspace(args[0])
    Geoloader::Solr.new.delete_by_workspace(args[0])
  end
end

#
# Show a list of all workspaces with document counts.
#
command :list do |c|
  c.syntax  = 'geoloader list'
  c.summary = 'List workspaces.'
  c.action do |args, options|
    puts Terminal::Table.new({
      :title => "GEOLOADER",
      :headings => ["Workspace", "# Assets"],
      :rows => Geoloader::Solr.new.get_workspace_counts
    })
  end
end

#
# Load a Shapefile.
#
# @param [String] file_path
# @param [Hash] manifest
# @param [Boolean] resque
#
def load_shapefile(file_path, manifest, resque)
  if resque
    Resque.enqueue(Geoloader::ShapefileLoader, file_path, manifest)
  else
    Geoloader::ShapefileLoader.new(file_path, manifest).load
  end
end

#
# Load a GeoTIFF.
#
# @param [String] file_path
# @param [Hash] manifest
# @param [Boolean] resque
#
def load_geotiff(file_path, manifest, resque)
  if resque
    Resque.enqueue(Geoloader::GeotiffLoader, file_path, manifest)
  else
    Geoloader::GeotiffLoader.new(file_path, manifest).load
  end
end
