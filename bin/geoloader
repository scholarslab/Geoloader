#!/usr/bin/env ruby

require 'rubygems'
require 'commander/import'
require 'geoloader'

program :version, '0.0.1'
program :description, 'Load GeoTIFFs and Shapefiles into Geonetwork, Geoserver, and PostgreSQL'

Geoloader.configure("~/.geoloader/config.yaml")

# TODO|dev
command :load do |c|
  c.syntax = 'geoloader load [filename]'
  c.summary = 'Load a YAML batch manifest.'
  c.action do |args, options|

    path = File.expand_path(args[0])
    yaml = YAML::load(File.read(path))

    Dir.glob("#{File.dirname(path)}/#{yaml["files"]}") do |f|
      case File.extname(f)
      when ".tif"
        loader = Geoloader::GeotiffLoader.new(f)
        loader.load
      when ".shp"
        loader = Geoloader::ShapefileLoader.new(f)
        loader.load
      end
    end

  end
end

# TODO|dev
command :reset do |c|
  c.syntax = 'geoloader reset'
  c.summary = 'Delete all assets (for development).'
  c.action do |args, options|

    geoserver = Geoloader::Geoserver.new
    geoserver.delete_workspace

    solr = Geoloader::Solr.new
    solr.clear_index

  end
end
